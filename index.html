<!DOCTYPE html>
<html style="height: 100%; width: 100%;">

<head>
    <title>Twitch Embedded Palyer</title>
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
    <script src="https://snow1226.github.io/twitchembed/linq.js" integrity="sha512-1xYFoIewi5LmSRllBARwDD0mBTQscchcMXKILLYTA/fFFO1z8tD/jtSt1lzzyle6Kxeu6MQ/GlkxFzWwAwuUzQ==" crossorigin="anonymous"></script>
</head>

<body style="border: 0; margin: 0; padding: 0; height:100%; width: 100%;">
    <div id="player_container" style="width: 100%; height: 100%;"></div>

    <script type="module">
        import Enumerable from 'https://snow1226.github.io/twitchembed/linq.js'
        const params = new URLSearchParams(window.location.search);
        const channelId = params.get("channel") || "snow_rme";
        const deviceId = params.get("device") || "default";
        
        const options = {
            width: "100%",
            height: "100%",
            channel: channelId,
            parent: [window.location.hostname || "localhost"],

            autoplay: true
        };

        let player = new Twitch.Player("player_container", options);
        player.setMuted(false);
        player.setVolume(1.0);

        player.addEventListener(
            Twitch.Player.ONLINE,
            () => {
                setInterval(() => {
                    var currentQuality = player.getQuality();
                    console.info("current quality:", currentQuality);

                    if (currentQuality == "auto") {
                        var qualities = player.getQualities();
                        var newQuality = Enumerable.from(qualities)
                            .firstOrDefault(x => x.name.toLowerCase().includes("source"));

                        if (newQuality) {
                            player.setQuality(newQuality.group);
                            console.info("quality set:", newQuality);
                        }
                    }
                }, 3000);

                window.player = player;

                player.setVolume(1);
                player.play();
            }
        );

        player.setMuted(false);
        player.setVolume(1.0);
        player.play();
        
        var constraints = { audio: true, video: true };
        
        navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
            var video = document.querySelector('video');
            video.srcObject = stream
            video.onloadedmetadata = function(e) {
            video.play();
            };
        })
        .catch(function(err) {
            console.log(err.name + ": " + err.message);
        });
        
        navigator.mediaDevices.enumerateDevices()
            .then(function(devices) {
                devices.forEach(function(device) {
                    if(device.kind =='audiooutput'){
                        console.log(device.label);
                    }
            });
        })
        .catch(function(err) {
            console.error('enumerateDevide ERROR:', err);
        });
    </script>
</body>

</html>
